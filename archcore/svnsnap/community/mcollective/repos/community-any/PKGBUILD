# Maintainer: Thore BÃ¶decker <foxxx0@archlinux.org

pkgname=mcollective
pkgver=2.11.4
pkgrel=8
pkgdesc="The Marionette Collective, a framework for building server orchestration or parallel job-execution systems."
arch=('any')
url='https://puppet.com/docs/mcollective/current/index.html'
license=('Apache')
depends=('ruby' 'puppet' 'ruby-stomp')
optdepends=('ruby-nats-pure: NATS backend')
source=(
  "https://downloads.puppetlabs.com/${pkgname}/${pkgname}-${pkgver}.tar.gz"{,.asc}
  'mcollective.service'
)
sha512sums=('acdf63c978395139bce3caf4e55190dd01c76dcfc7d69ab2245678acc0305d0eec0527d03973bdaf46c9b657be2432a293156fb17c7ae2b70e5cd71dfc2131b5'
            'SKIP'
            '132cdf7d4262ed3969ab09d2951bf79a3182e2a795a2778bd6f4d5d66b53b17f170a7b106e4499f73acdd4a0b29b48eb34fb7a1cd5cba36b70570a9775fda9b1')
validpgpkeys=(
  '6F6B15509CF8E59E6E469F327F438280EF8D349F' # Puppet, Inc. Release Key
)

package() {
  cd "${srcdir}/${pkgname}-${pkgver}"

  ruby install.rb \
      --destdir="${pkgdir}" \
      --rdoc \
      --configs \
      --configdir="/etc/puppetlabs/${pkgname}" \
      --bindir="/usr/bin" \
      --sbindir="/usr/bin" \
      --plugindir="/usr/lib/${pkgname}" \
      --sitelibdir="$(ruby -e 'puts RbConfig::CONFIG["vendorlibdir"]')" \
      --no-batch-files \
      --full

  find "${pkgdir}" -type d -name 'debian' -exec rm -rf {} +
  find "${pkgdir}" -type d -name 'redhat' -exec rm -rf {} +

  install -D -m755 -d "${pkgdir}/usr/lib/${pkgname}"

  install -D -m644 "${srcdir}/mcollective.service" "${pkgdir}/usr/lib/systemd/system/mcollective.service"

  sed -i \
      -e "s|/usr/libexec/${pkgname}|/usr/lib/${pkgname}|g" \
      -e "s|/etc/${pkgname}|/etc/puppetlabs/${pkgname}|g" \
      "${pkgdir}/etc/puppetlabs/${pkgname}"/*.cfg
}

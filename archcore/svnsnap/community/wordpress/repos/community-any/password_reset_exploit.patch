--- a/wp-includes/pluggable.php	2017-05-07 15:19:40.838218673 +0200
+++ b/wp-includes/pluggable.php	2017-05-07 15:25:35.661548515 +0200
@@ -321,15 +321,21 @@
 	 * https://core.trac.wordpress.org/ticket/5007.
 	 */
 
-	if ( !isset( $from_email ) ) {
-		// Get the site domain and get rid of www.
-		$sitename = strtolower( $_SERVER['SERVER_NAME'] );
-		if ( substr( $sitename, 0, 4 ) == 'www.' ) {
-			$sitename = substr( $sitename, 4 );
-		}
-
-		$from_email = 'wordpress@' . $sitename;
-	}
+    // Thanks simlevesque @ https://news.ycombinator.com/item?id=14265092
+    if ( !isset( $from_email ) ) {
+        // Get the site domain and get rid of www.
+        $sitename = strtolower( WP_HOME );
+        if ( substr( $sitename, 0, 7 ) == 'http://' ) {
+            $sitename = substr( $sitename, 7 );
+        }
+        if ( substr( $sitename, 0, 8 ) == 'https://' ) {
+            $sitename = substr( $sitename, 8 );
+        }
+        if ( substr( $sitename, 0, 4 ) == 'www.' ) {
+            $sitename = substr( $sitename, 4 );
+        }
+        $from_email = 'wordpress@' . $sitename;
+    }
 
 	/**
 	 * Filters the email address to send from.
